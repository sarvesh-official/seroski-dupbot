name: Quick Database Actions

on:
  workflow_dispatch:
    inputs:
      quick_action:
        description: 'Quick action to perform'
        required: true
        type: choice
        options:
        - 'validate-all-apis'
        - 'validate-pinecone-only'
        - 'validate-github-only'
        - 'validate-gemini-only'
        - 'populate-issues-safe'
        - 'debug-database-status'

permissions:
  issues: read
  contents: read

jobs:
  quick-action:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Validate All APIs
        if: github.event.inputs.quick_action == 'validate-all-apis'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX: ${{ secrets.PINECONE_INDEX }}
        run: node scripts/validate-apis.js

      - name: Validate Pinecone Only
        if: github.event.inputs.quick_action == 'validate-pinecone-only'
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX: ${{ secrets.PINECONE_INDEX }}
        run: node scripts/validate-apis.js pinecone

      - name: Validate GitHub Only
        if: github.event.inputs.quick_action == 'validate-github-only'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: node scripts/validate-apis.js github

      - name: Validate Gemini Only
        if: github.event.inputs.quick_action == 'validate-gemini-only'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/validate-apis.js gemini

      - name: Populate Issues (Safe)
        if: github.event.inputs.quick_action == 'populate-issues-safe'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX: ${{ secrets.PINECONE_INDEX }}
        run: |
          echo "🔍 Pre-validating all APIs..."
          node scripts/validate-apis.js
          echo "🚀 Populating existing issues (safe operation)..."
          node scripts/populate-existing-issues.js

      - name: Debug Database Status
        if: github.event.inputs.quick_action == 'debug-database-status'
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX: ${{ secrets.PINECONE_INDEX }}
        run: |
          echo "🔍 Validating Pinecone connection..."
          node scripts/validate-apis.js pinecone
          echo "🔍 Getting detailed database status..."
          node scripts/debug-pinecone.js

      - name: Action Summary
        if: always()
        run: |
          echo "### 🎯 Quick Action Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** ${{ github.event.inputs.quick_action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🛠️ All actions use centralized validation scripts for consistency." >> $GITHUB_STEP_SUMMARY